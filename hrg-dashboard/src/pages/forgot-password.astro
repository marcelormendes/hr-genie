---
import MainLayout from "../layouts/MainLayout.astro";
---

<MainLayout title="Forgot Password - HR Genie">
  <div class="container mx-auto px-4 py-12">
    <div class="max-w-md mx-auto bg-white rounded-lg shadow-lg p-8">
      <h1 class="text-2xl font-bold text-center mb-6">Forgot Your Password?</h1>
      <p class="text-center text-gray-600 mb-6">
        Enter your email address and we'll send you a link to reset your
        password.
      </p>

      {/* Divs for script-controlled messages */}
      <div id="responseMessageContainer" class="mb-6">
        <div
          id="errorMessage"
          class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"
          role="alert"
        >
          <p id="errorText"></p>
        </div>
        <div
          id="successMessage"
          class="hidden bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded"
          role="alert"
        >
          <p id="successText"></p>
        </div>
      </div>

      <form class="space-y-4" id="forgotPasswordForm">
        {/* Removed action/method, added id */}
        <div>
          <label
            for="email"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Email Address</label
          >
          <input
            type="email"
            id="email"
            name="email"
            required
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring focus:ring-indigo-200"
          />
        </div>

        <button
          type="submit"
          id="resetButton"
          class="w-full bg-indigo-600 text-white font-medium py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
        >
          Reset Password
        </button>
      </form>

      <div class="mt-6 text-center">
        <a href="/login" class="text-sm text-indigo-600 hover:text-indigo-500"
          >Back to Login</a
        >
      </div>
    </div>
  </div>

  <script>
    document
      .getElementById("forgotPasswordForm")
      ?.addEventListener("submit", async (e) => {
        e.preventDefault();

        const emailInput = document.getElementById("email") as HTMLInputElement;
        const email = emailInput.value;
        const resetButton = document.getElementById(
          "resetButton"
        ) as HTMLButtonElement;
        const errorMessageDiv = document.getElementById("errorMessage")!;
        const errorTextP = document.getElementById("errorText")!;
        const successMessageDiv = document.getElementById("successMessage")!;
        const successTextP = document.getElementById("successText")!;

        // Clear previous messages & disable button
        errorMessageDiv.classList.add("hidden");
        successMessageDiv.classList.add("hidden");
        resetButton.disabled = true;
        resetButton.textContent = "Sending...";

        if (!email) {
          errorTextP.textContent = "Please enter your email address.";
          errorMessageDiv.classList.remove("hidden");
          resetButton.disabled = false;
          resetButton.textContent = "Reset Password";
          return;
        }

        try {
          const backendUrl =
            import.meta.env.BACKEND_URL || "http://localhost:3000"; // Updated default port
          const response = await fetch(
            `${backendUrl}/api/v1/auth/forgot-password`,
            {
              // Changed URL
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ email }),
            }
          );

          if (!response.ok) {
            const errorData = await response
              .json()
              .catch(() => ({ message: "Request failed. Please try again." }));
            throw new Error(
              errorData.message || "Request failed. Please try again."
            );
          }

          // Show success message
          successTextP.textContent =
            "Password reset link has been sent to your email."; // Or get message from response
          successMessageDiv.classList.remove("hidden");
          // Optionally disable form fields after success
          emailInput.disabled = true;
          resetButton.textContent = "Sent!";
        } catch (error) {
          errorTextP.textContent =
            error instanceof Error
              ? error.message
              : "An unknown error occurred.";
          errorMessageDiv.classList.remove("hidden");
          resetButton.disabled = false;
          resetButton.textContent = "Reset Password";
        }
      });
  </script>
</MainLayout>
